#include<ulib.h>

#define NUM_ACCESS 1738
#define NUM_ELEM 531
#define MICRO_SEC 3000 //3000 cycles
#define SIZE 1738

#define RDTSC_START()            \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         : "=r" (start_hi), "=r" (start_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");

#define RDTSC_STOP()              \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         "CPUID\n\t" \
                         : "=r" (end_hi), "=r" (end_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");


u64 uelapsed(u32 start_hi, u32 start_lo, u32 end_hi, u32 end_lo)
{
        u64 start = (((u64)start_hi) << 32) | start_lo;
        u64 end   = (((u64)end_hi)   << 32) | end_lo;
        return end-start;
}
int main(u64 arg1, u64 arg2, u64 arg3, u64 arg4, u64 arg5)
{
    u32 start_hi = 0, start_lo = 0, end_hi = 0, end_lo = 0;
    u32 target_count = MICRO_SEC*100; //values at 100 usec interval
    u32 loop_counter = 1024;
    u64 rdtsc_count = 0;
    register int count = 0;
    do{
        count = 0;
	rdtsc_count = 0;
	loop_counter = (loop_counter<<1);
        RDTSC_START();    
        while(count < loop_counter){
            count += 1;
	} 
        RDTSC_STOP();
        rdtsc_count = uelapsed(start_hi,start_lo,end_hi,end_lo);
    }while(rdtsc_count<target_count);
    printf("counter:%u rdtsc:%u\n",loop_counter,rdtsc_count);
    u16* input = (u16*)mmap(NULL, SIZE*sizeof(u16), PROT_READ | PROT_WRITE, 0);
    u32 index[NUM_ELEM] = {0,1,5,12,16,23,24,25,26,27,28,29,30,31,41,43,47,59,60,61,62,63,68,72,73,77,81,82,99,111,114,124,125,135,139,140,141,142,143,144,145,146,147,148,149,150,151,153,154,155,156,161,162,163,164,165,166,167,168,169,170,171,172,173,174,183,184,185,186,187,189,190,192,193,199,200,206,207,208,238,244,245,249,251,257,258,263,264,266,267,270,276,285,286,287,291,293,295,296,297,298,299,301,303,304,305,312,320,321,323,326,328,329,330,339,340,341,342,343,345,346,347,348,353,361,368,371,376,377,384,389,398,405,408,414,415,419,428,429,447,516,518,519,524,525,527,528,529,530,531,532,533,535,536,537,538,539,540,541,543,544,550,551,553,554,555,556,557,558,559,561,562,563,565,566,567,568,569,570,571,572,580,582,583,584,585,587,588,589,590,591,592,593,594,595,598,603,604,605,606,607,608,609,610,611,613,614,615,620,622,628,634,640,641,642,643,644,646,647,648,657,660,662,666,670,671,672,675,683,684,685,697,701,702,712,715,719,727,728,735,750,757,786,789,840,847,848,852,866,870,875,879,882,889,893,902,908,923,924,925,930,932,937,938,940,942,943,950,951,954,967,977,981,992,993,994,995,996,997,998,1000,1001,1002,1003,1004,1005,1006,1007,1009,1010,1011,1012,1013,1014,1015,1017,1018,1019,1021,1022,1023,1026,1027,1029,1030,1035,1041,1044,1051,1054,1055,1056,1057,1058,1059,1060,1061,1062,1063,1064,1066,1067,1068,1069,1070,1071,1072,1073,1074,1075,1077,1078,1079,1082,1087,1090,1091,1092,1093,1096,1099,1103,1104,1105,1106,1107,1108,1118,1120,1125,1126,1132,1133,1137,1138,1139,1146,1168,1169,1172,1173,1191,1199,1206,1211,1213,1214,1217,1218,1220,1221,1222,1223,1225,1227,1228,1229,1230,1231,1232,1233,1234,1235,1238,1239,1242,1243,1244,1246,1251,1257,1258,1268,1270,1274,1275,1277,1278,1279,1280,1289,1290,1294,1296,1324,1328,1332,1333,1341,1347,1348,1350,1353,1356,1357,1358,1361,1364,1369,1375,1381,1382,1387,1388,1402,1408,1411,1412,1416,1417,1421,1422,1423,1424,1425,1426,1427,1435,1441,1442,1451,1462,1469,1470,1476,1482,1483,1484,1489,1502,1507,1508,1511,1517,1521,1549,1550,1553,1554,1555,1558,1567,1571,1579,1584,1585,1590,1624,1635,1636,1637,1639,1641,1644,1645,1646,1647,1648,1649,1650,1651,1652,1653,1655,1656,1657,1660,1661,1662,1663,1664,1666,1667,1668,1669,1670,1671,1672,1673,1674,1675,1677,1678,1679,1680,1681,1683,1685,1686,1687,1688,1689,1690,1691,1692,1693,1694,1697,1698,1699,1701,1702,1719,1720,1721,1722,1723,1724,1725,1736,1737};
    u32 value[NUM_ELEM] = {32,48,4,8,8,8,20,24,20,24,28,16,20,36,4,8,8,8,28,16,40,20,16,8,16,40,12,8,16,8,8,8,8,8,32,28,80,24,48,40,8,16,20,12,16,24,20,28,48,16,40,16,20,32,16,44,48,4,16,16,16,8,8,72,36,24,40,40,24,20,20,8,28,16,4,9,20,4,9,8,56,32,16,8,40,24,32,32,64,52,16,32,20,5,8,8,8,40,68,8,13,9,16,8,72,64,8,49,16,8,8,8,24,48,16,8,20,5,8,8,88,72,88,32,8,8,8,24,40,5,8,8,56,8,8,54,9,48,28,8,8,16,16,48,8,72,16,56,48,40,32,64,16,56,61,64,23,72,12,8,8,16,80,40,24,56,32,12,8,13,8,8,16,56,24,8,72,64,16,24,8,1,24,64,40,53,56,40,32,21,72,57,38,48,36,8,44,32,48,13,64,65,62,24,4,8,8,8,8,8,8,8,24,56,8,16,56,56,24,8,8,24,8,32,24,65,16,8,32,64,48,8,16,25,8,32,56,40,16,8,48,8,8,32,8,32,24,1,16,24,40,8,24,52,8,20,24,16,76,24,8,24,16,16,8,16,8,56,16,8,8,9,8,48,65,88,64,48,8,1,24,17,48,48,52,8,40,60,24,16,80,57,64,64,56,24,16,40,40,40,8,48,16,12,80,1,8,16,28,8,56,88,65,56,48,32,36,32,1,40,40,48,20,52,64,56,32,40,24,16,8,25,20,8,12,8,24,68,16,1,8,16,48,48,72,8,8,20,8,32,32,56,8,16,60,40,8,48,36,1,1,1,16,5,16,8,8,48,56,64,32,32,16,21,56,16,24,40,32,32,16,8,1,5,56,45,72,8,36,8,64,40,8,24,20,16,48,56,64,8,84,16,16,16,8,40,56,60,8,21,4,12,32,16,76,24,16,16,40,8,32,20,4,8,4,16,16,16,24,48,48,88,8,64,64,16,8,8,8,40,8,20,8,16,8,40,36,8,32,8,8,48,8,57,5,1,8,8,24,8,16,8,24,8,16,32,8,24,32,48,12,8,8,72,32,56,8,8,8,64,1,57,29,65,56,40,16,80,56,24,8,8,16,24,72,40,48,56,68,64,38,65,32,56,40,56,40,48,56,8,56,8,76,48,64,8,8,8,64,20,24,16,32,65,60,60,8,72,52,4,16};
    unsigned prev = 0;
    for( int i=0; i<NUM_ELEM; i++ ){
        unsigned ind = index[i];
	unsigned val = value[i];
	while( prev < ind ){
	    input[prev] = 0;
	    prev += 1;
	}
	input[prev] = val;
	prev += 1;
    }
    unsigned size = 0;
    checkpoint_start();
    gem5_dump_stats();
    gem5_reset_stats();
    for( int j=0; j<NUM_ACCESS; j++ ){
        size = input[j%SIZE];
        if(size){
	    int array[size];
	    umemset(array,0,size);
	}
	count = 0;
	while(count < loop_counter){
            count += 1;
	}
    }
    checkpoint_end();
    gem5_dump_stats();
    gem5_reset_stats();
    checkpoint_stats();

    return 0;
}
