#include<ulib.h>

#define NUM_ACCESS 200
#define NUM_ELEM 451
#define MICRO_SEC 3000 //3000 cycles
#define SIZE 1641

#define RDTSC_START()            \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         : "=r" (start_hi), "=r" (start_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");

#define RDTSC_STOP()              \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         "CPUID\n\t" \
                         : "=r" (end_hi), "=r" (end_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");


u64 uelapsed(u32 start_hi, u32 start_lo, u32 end_hi, u32 end_lo)
{
        u64 start = (((u64)start_hi) << 32) | start_lo;
        u64 end   = (((u64)end_hi)   << 32) | end_lo;
        return end-start;
}
int main(u64 arg1, u64 arg2, u64 arg3, u64 arg4, u64 arg5)
{
    u32 start_hi = 0, start_lo = 0, end_hi = 0, end_lo = 0;
    u32 target_count = MICRO_SEC*100; //values at 100 usec interval
    u32 loop_counter = 1024;
    u64 rdtsc_count = 0;
    register int count = 0;
    do{
        count = 0;
	rdtsc_count = 0;
	loop_counter = (loop_counter<<1);
        RDTSC_START();    
        while(count < loop_counter){
            count += 1;
	} 
        RDTSC_STOP();
        rdtsc_count = uelapsed(start_hi,start_lo,end_hi,end_lo);
    }while(rdtsc_count<target_count);
    printf("counter:%u rdtsc:%u\n",loop_counter,rdtsc_count);
    u16* input = (u16*)mmap(NULL, SIZE*sizeof(u16), PROT_READ | PROT_WRITE, 0);
    u32 index[NUM_ELEM] = {0,22,23,24,36,47,58,59,73,74,75,76,80,91,96,97,101,104,105,108,109,124,125,133,136,142,143,146,152,157,158,164,173,177,183,184,190,193,198,203,210,211,212,218,222,226,230,231,235,242,243,246,249,272,275,283,284,285,291,294,296,297,298,299,302,305,307,312,314,319,323,324,331,339,345,346,348,351,355,356,360,364,368,372,377,378,380,390,391,420,422,438,440,454,456,466,467,474,476,479,498,499,523,524,534,535,537,538,541,548,558,562,568,569,574,575,576,587,595,600,601,602,606,607,623,626,655,664,673,675,676,678,679,681,682,687,688,691,694,696,701,709,717,718,719,721,722,723,724,727,728,729,730,734,735,736,740,741,743,745,746,747,752,753,756,758,761,763,764,775,778,783,784,791,795,812,813,818,822,840,843,844,851,852,858,863,864,865,869,870,873,874,877,878,881,882,887,893,895,896,897,906,913,919,930,931,934,937,940,947,951,968,986,991,995,998,1002,1009,1011,1015,1026,1030,1035,1038,1042,1048,1055,1056,1057,1058,1059,1060,1062,1063,1064,1065,1066,1067,1068,1069,1070,1071,1072,1073,1074,1075,1077,1078,1079,1080,1081,1082,1083,1084,1085,1086,1087,1088,1089,1090,1091,1092,1093,1094,1095,1096,1097,1098,1099,1100,1101,1102,1103,1104,1105,1106,1107,1108,1109,1110,1111,1112,1113,1114,1115,1116,1117,1118,1119,1120,1121,1123,1124,1125,1126,1127,1128,1129,1130,1135,1142,1148,1149,1156,1159,1160,1162,1165,1166,1168,1171,1176,1177,1178,1180,1182,1185,1187,1188,1196,1222,1223,1226,1229,1232,1236,1238,1239,1240,1246,1252,1256,1280,1281,1286,1287,1289,1294,1303,1310,1311,1312,1318,1319,1320,1322,1328,1329,1343,1344,1355,1377,1378,1393,1401,1411,1413,1419,1423,1426,1448,1449,1450,1451,1454,1459,1471,1476,1477,1480,1481,1485,1488,1490,1496,1497,1504,1507,1513,1517,1520,1521,1522,1528,1533,1534,1535,1536,1538,1539,1541,1542,1546,1547,1553,1554,1565,1566,1570,1571,1572,1573,1578,1579,1580,1581,1582,1583,1597,1598,1599,1601,1602,1603,1604,1605,1606,1607,1608,1609,1610,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1625,1626,1627,1628,1629,1630,1631,1632,1633,1634,1635,1636,1637,1638,1639,1640};
    u32 value[NUM_ELEM] ={8,8,40,8,8,8,56,8,16,8,8,8,24,16,24,8,24,16,24,12,8,8,8,8,8,8,8,40,8,4,28,52,8,8,84,16,8,8,4,8,60,68,24,40,8,24,24,24,24,32,64,8,4,4,25,84,24,2,16,8,16,104,112,8,4,4,8,4,24,16,56,8,12,16,72,20,12,32,16,8,16,16,32,12,16,4,8,8,48,8,32,6,4,8,12,8,40,36,8,48,36,89,8,28,16,56,16,8,32,8,8,88,72,16,28,81,16,8,8,48,24,8,24,24,8,40,8,8,8,8,16,32,32,24,40,8,16,8,8,8,32,32,48,88,48,8,104,84,33,16,96,84,33,52,88,93,12,16,4,40,88,85,12,8,8,4,4,8,12,8,16,32,16,8,48,64,64,8,64,64,48,16,32,32,64,80,72,61,24,24,24,32,8,48,4,8,4,12,8,8,8,48,8,24,8,24,8,40,8,24,40,4,8,48,8,16,48,4,4,8,4,8,8,4,20,56,92,68,72,88,80,12,37,100,74,104,92,80,60,88,64,32,24,44,52,24,40,10,8,60,36,76,88,8,88,64,88,69,8,40,96,56,32,72,64,24,56,72,96,80,96,85,16,80,80,69,12,100,84,37,32,92,84,37,28,28,12,100,16,32,96,56,16,16,48,64,16,48,64,4,8,24,16,8,8,16,8,40,8,8,8,24,32,8,8,64,64,8,56,64,8,16,8,8,8,8,8,16,8,8,8,48,8,56,40,24,8,24,4,40,8,56,40,24,4,8,48,8,8,8,16,36,33,8,8,8,8,48,8,16,40,112,44,36,88,24,16,76,8,16,24,48,48,8,48,8,16,8,32,8,48,40,40,8,16,24,8,40,16,40,40,8,64,48,32,16,8,40,32,48,56,8,8,48,56,56,48,24,112,64,48,40,56,48,56,48,56,56,32,56,32,72,88,56,8,48,48,56,48,48,64,48,56,56,8,72,88,40,24,40,40,32,56,56,48,64,48,56,40,48,72};  
    unsigned prev = 0;
    for( int i=0; i<NUM_ELEM; i++ ){
        unsigned ind = index[i];
	unsigned val = value[i];
	while( prev < ind ){
	    input[prev] = 0;
	    prev += 1;
	}
	input[prev] = val;
	prev += 1;
    }
    unsigned size = 0;
    checkpoint_start();
    gem5_dump_stats();
    gem5_reset_stats();
    for( int j=0; j<NUM_ACCESS; j++ ){
        size = input[j%SIZE];
        if(size){
	    int array[size];
	    umemset(array,0,size);
	}
	count = 0;
	while(count < loop_counter){
            count += 1;
	}
    }
    checkpoint_end();
    gem5_dump_stats();
    gem5_reset_stats();
    checkpoint_stats();
    return 0;
}
