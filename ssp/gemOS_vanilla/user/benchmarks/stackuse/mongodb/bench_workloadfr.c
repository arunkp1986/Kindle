#include<ulib.h>

#define NUM_ACCESS 1940
#define NUM_ELEM 570
#define MICRO_SEC 3000 //3000 cycles
#define SIZE 1940

#define RDTSC_START()            \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         : "=r" (start_hi), "=r" (start_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");

#define RDTSC_STOP()              \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         "CPUID\n\t" \
                         : "=r" (end_hi), "=r" (end_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");


u64 uelapsed(u32 start_hi, u32 start_lo, u32 end_hi, u32 end_lo)
{
        u64 start = (((u64)start_hi) << 32) | start_lo;
        u64 end   = (((u64)end_hi)   << 32) | end_lo;
        return end-start;
}
int main(u64 arg1, u64 arg2, u64 arg3, u64 arg4, u64 arg5)
{
    u32 start_hi = 0, start_lo = 0, end_hi = 0, end_lo = 0;
    u32 target_count = MICRO_SEC*100; //values at 100 usec interval
    u32 loop_counter = 1024;
    u64 rdtsc_count = 0;
    register int count = 0;
    do{
        count = 0;
	rdtsc_count = 0;
	loop_counter = (loop_counter<<1);
        RDTSC_START();    
        while(count < loop_counter){
            count += 1;
	} 
        RDTSC_STOP();
        rdtsc_count = uelapsed(start_hi,start_lo,end_hi,end_lo);
    }while(rdtsc_count<target_count);
    printf("counter:%u rdtsc:%u\n",loop_counter,rdtsc_count);
    u16* input = (u16*)mmap(NULL, SIZE*sizeof(u16), PROT_READ | PROT_WRITE, 0);
    u32 index[NUM_ELEM] = {0,1,3,6,8,10,11,12,16,19,20,22,24,25,26,28,29,31,33,36,37,38,40,49,51,55,57,58,72,73,74,75,77,78,79,81,83,90,92,96,104,106,115,117,118,119,120,132,133,135,137,138,139,140,141,142,144,145,146,147,148,149,150,151,152,153,156,157,159,193,197,198,218,219,240,241,242,243,248,250,256,261,262,266,267,268,282,283,284,288,289,290,294,297,298,299,301,302,303,308,309,310,311,312,313,314,315,317,318,322,323,324,325,328,332,344,345,346,358,363,364,372,373,374,377,387,388,392,400,406,409,410,412,423,429,430,434,436,442,443,447,448,449,454,461,468,470,476,481,482,483,484,485,486,492,493,497,505,512,515,521,522,525,534,535,545,546,549,553,557,558,569,573,576,587,588,591,597,601,602,603,604,609,611,617,622,625,631,632,633,637,639,642,652,653,667,670,677,679,689,690,694,700,701,702,703,704,705,706,707,708,710,712,713,714,715,716,717,718,719,720,721,722,723,724,726,727,728,729,730,731,732,733,734,735,736,737,738,739,741,742,747,748,749,751,753,757,758,765,772,794,795,801,807,809,810,811,813,818,819,820,822,823,825,838,839,841,842,844,845,850,851,852,855,859,860,864,874,876,877,883,888,924,936,938,950,957,960,963,966,969,970,989,996,997,998,999,1000,1001,1014,1015,1020,1026,1030,1035,1037,1038,1052,1064,1070,1073,1078,1081,1087,1090,1095,1097,1101,1102,1105,1109,1124,1125,1126,1132,1133,1136,1148,1153,1154,1155,1156,1157,1159,1163,1170,1187,1196,1197,1198,1199,1200,1202,1206,1220,1221,1222,1223,1237,1241,1252,1255,1259,1270,1271,1273,1278,1285,1287,1291,1295,1296,1299,1307,1308,1309,1310,1311,1312,1314,1315,1316,1317,1318,1320,1321,1322,1323,1324,1325,1341,1355,1356,1357,1358,1359,1360,1361,1362,1363,1364,1365,1366,1367,1369,1370,1371,1372,1377,1384,1386,1389,1400,1401,1402,1403,1429,1433,1435,1436,1437,1438,1440,1441,1442,1446,1449,1455,1461,1462,1475,1480,1482,1483,1484,1485,1486,1487,1489,1490,1491,1493,1495,1496,1530,1531,1532,1539,1544,1545,1551,1552,1555,1558,1562,1565,1572,1573,1574,1586,1610,1611,1612,1614,1623,1624,1629,1630,1631,1633,1634,1635,1637,1639,1640,1646,1648,1650,1651,1652,1656,1657,1671,1676,1677,1679,1680,1686,1689,1690,1691,1692,1693,1694,1695,1696,1697,1698,1699,1700,1701,1702,1703,1704,1709,1710,1711,1718,1723,1724,1726,1733,1737,1764,1767,1768,1769,1772,1780,1784,1792,1796,1797,1801,1827,1828,1829,1830,1831,1841,1844,1849,1850,1851,1852,1854,1855,1856,1857,1861,1862,1863,1864,1865,1866,1867,1868,1869,1870,1871,1872,1873,1874,1876,1881,1882,1887,1892,1900,1901,1906,1907,1909,1915,1917,1920,1924,1925,1926,1927,1928,1930,1931,1932,1933,1934,1935,1936,1938,1939};
    u32 value[NUM_ELEM] = {16,16,16,16,16,16,8,8,16,16,4,16,4,4,4,8,8,4,4,4,16,4,4,4,4,8,16,8,8,16,16,8,8,16,8,8,8,8,8,16,8,8,32,16,24,24,16,16,24,4,8,24,8,8,16,20,8,24,24,16,24,16,12,32,24,16,20,28,20,20,8,8,5,8,24,24,36,16,8,8,24,32,8,4,8,8,12,12,32,16,4,16,13,8,16,32,16,12,8,5,5,8,24,48,24,8,8,32,36,8,64,52,60,1,24,8,16,16,8,16,8,40,60,16,13,5,8,13,8,8,52,40,16,8,24,64,16,8,56,8,8,56,8,32,8,8,8,64,40,88,88,80,56,24,1,4,8,8,56,8,57,5,9,32,44,32,33,8,8,8,8,8,32,8,4,8,24,32,16,81,36,56,77,8,40,12,8,8,8,20,16,16,32,32,64,32,8,8,24,32,40,8,37,80,55,48,12,40,24,48,32,32,8,32,72,8,16,48,64,64,56,48,40,41,28,80,80,64,64,24,24,8,8,64,53,72,25,58,28,72,8,41,62,28,32,24,32,24,1,8,64,20,8,76,72,24,56,40,72,16,64,56,24,8,40,72,16,28,20,8,40,32,1,8,8,16,8,8,8,16,20,8,1,1,9,32,36,32,8,4,4,8,16,32,48,32,40,16,8,16,8,16,1,24,8,8,16,8,8,8,24,32,8,8,24,8,16,8,48,8,24,64,16,16,32,20,8,24,40,20,64,36,4,8,8,8,8,48,16,16,56,48,40,8,8,8,76,24,8,41,8,32,56,40,16,8,16,40,8,32,8,8,8,32,16,24,49,56,24,24,24,32,8,8,64,57,72,40,48,8,8,8,64,64,68,16,16,76,56,60,8,49,80,72,48,24,24,24,8,8,8,24,48,56,72,8,8,32,56,48,56,24,8,8,32,9,8,8,40,64,48,8,40,8,8,24,32,25,32,56,24,8,24,16,56,24,32,8,24,4,72,20,16,16,16,32,8,40,52,1,5,16,40,24,8,72,24,16,1,21,40,36,1,21,40,44,1,21,40,16,24,8,8,80,36,32,8,64,16,12,48,20,13,16,89,52,68,8,64,44,48,52,28,12,40,68,8,8,24,32,8,57,5,9,24,8,8,16,8,24,8,16,32,8,64,16,56,56,32,25,8,40,32,88,38,65,32,72,24,24,68,80,54,1,64,32,64,8,8,72,56,32,8,12,20,98,16,8,16,40,8,1,16,24,8,32,64,16,56,56,32,48,57,36,76,24,48,18,32,8};
    unsigned prev = 0;
    for( int i=0; i<NUM_ELEM; i++ ){
        unsigned ind = index[i];
	unsigned val = value[i];
	while( prev < ind ){
	    input[prev] = 0;
	    prev += 1;
	}
	input[prev] = val;
	prev += 1;
    }
    unsigned size = 0;
    checkpoint_start();
    gem5_dump_stats();
    gem5_reset_stats();
    for( int j=0; j<NUM_ACCESS; j++ ){
        size = input[j%SIZE];
        if(size){
	    int array[size];
	    umemset(array,0,size);
	}
	count = 0;
	while(count < loop_counter){
            count += 1;
	}
    }
    checkpoint_end();
    gem5_dump_stats();
    gem5_reset_stats();
    checkpoint_stats();

    return 0;
}
