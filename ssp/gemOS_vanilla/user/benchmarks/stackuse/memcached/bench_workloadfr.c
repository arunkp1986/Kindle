#include<ulib.h>

#define NUM_ACCESS 3043
#define NUM_ELEM 638
#define MICRO_SEC 3000 //3000 cycles
#define SIZE 3044

#define RDTSC_START()            \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         : "=r" (start_hi), "=r" (start_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");

#define RDTSC_STOP()              \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         "CPUID\n\t" \
                         : "=r" (end_hi), "=r" (end_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");


u64 uelapsed(u32 start_hi, u32 start_lo, u32 end_hi, u32 end_lo)
{
        u64 start = (((u64)start_hi) << 32) | start_lo;
        u64 end   = (((u64)end_hi)   << 32) | end_lo;
        return end-start;
}
int main(u64 arg1, u64 arg2, u64 arg3, u64 arg4, u64 arg5)
{
    u32 start_hi = 0, start_lo = 0, end_hi = 0, end_lo = 0;
    u32 target_count = MICRO_SEC*100; //values at 100 usec interval
    u32 loop_counter = 1024;
    u64 rdtsc_count = 0;
    register int count = 0;
    do{
        count = 0;
	rdtsc_count = 0;
	loop_counter = (loop_counter<<1);
        RDTSC_START();    
        while(count < loop_counter){
            count += 1;
	} 
        RDTSC_STOP();
        rdtsc_count = uelapsed(start_hi,start_lo,end_hi,end_lo);
    }while(rdtsc_count<target_count);
    printf("counter:%u rdtsc:%u\n",loop_counter,rdtsc_count);
    u16* input = (u16*)mmap(NULL, SIZE*sizeof(u16), PROT_READ | PROT_WRITE, 0);
    u32 index[NUM_ELEM] = {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,166,167,168,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,2532,2533,2535,2540,2541,2543,2545,2546,2547,2548,2549,2550,2552,2556,2558,2559,2560,2561,2562,2563,2566,2567,2568,2569,2570,2571,2572,2573,2574,2575,2576,2580,2581,2582,2583,2584,2585,2586,2587,2589,2590,2594,2595,2596,2597,2598,2599,2600,2601,2602,2603,2609,2610,2612,2613,2614,2615,2616,2617,2620,2621,2622,2623,2624,2625,2626,2627,2630,2631,2632,2633,2634,2635,2636,2637,2638,2640,2641,2644,2645,2646,2647,2648,2649,2650,2651,2652,2653,2657,2658,2659,2660,2661,2662,2663,2665,2671,2674,2675,2676,2677,2679,2682,2684,2685,2687,2688,2689,2692,2693,2694,2695,2696,2697,2698,2699,2700,2701,2702,2706,2707,2708,2709,2710,2711,2712,2714,2715,2718,2719,2720,2721,2722,2723,2724,2725,2726,2727,2732,2733,2735,2736,2737,2738,2740,2743,2745,2746,2748,2749,2750,2753,2754,2755,2756,2757,2758,2759,2760,2762,2763,2767,2768,2769,2770,2771,2772,2773,2774,2775,2779,2780,2781,2782,2783,2784,2785,2787,2793,2794,2797,2799,2800,2801,2802,2804,2807,2808,2809,2810,2811,2812,2813,2814,2817,2818,2819,2820,2821,2822,2823,2824,2825,2826,2827,2831,2832,2833,2834,2835,2836,2837,2838,2840,2841,2842,2843,2844,2846,2850,2851,2852,2853,2854,2855,2856,2857,2858,2859,2860,2861,2862,2864,2865,2866,2867,2868,2869,2870,2871,2874,2875,2876,2877,2878,2879,2880,2881,2883,2884,2885,2886,2887,2888,2891,2892,2893,2894,2895,2896,2897,2898,2899,2900,2902,2903,2904,2905,2906,2907,2909,2910,2911,2912,2913,2914,2916,2917,2918,2919,2920,2923,2924,2925,2926,2927,2929,2930,2931,2932,2934,2935,2936,2937,2938,2940,2941,2942,2943,2945,2946,2947,2948,2949,2951,2952,2953,2954,2955,2956,2957,2958,2959,2960,2961,2962,2963,2964,2966,2967,2968,2969,2970,2971,2972,2973,2974,2975,2977,2978,2979,2980,2982,2983,2984,2985,2986,2987,2988,2989,2990,2991,2992,2993,2995,2996,2997,2998,3000,3001,3002,3003,3004,3005,3006,3007,3008,3009,3010,3011,3012,3013,3014,3015,3017,3018,3019,3020,3022,3023,3024,3025,3026,3027,3028,3029,3030,3031,3032,3033,3034,3035,3036,3037,3038,3039,3040,3041,3042,3043};
    u32 value[NUM_ELEM] = {40,8,16,40,8,16,32,8,24,32,8,24,16,24,24,16,24,24,16,24,24,16,24,24,16,24,24,24,16,24,16,24,24,8,32,24,32,16,24,32,24,32,16,24,32,24,24,16,24,40,16,24,24,24,40,16,24,24,24,40,8,24,32,24,40,8,24,32,24,40,8,24,32,16,32,16,24,40,16,24,24,24,40,16,32,16,32,32,24,40,24,40,24,32,16,40,16,32,32,24,40,24,40,16,40,16,32,32,24,32,24,40,8,32,8,37,64,48,56,64,64,56,48,72,48,56,48,64,48,72,48,64,56,48,72,64,56,72,72,56,72,64,72,64,56,72,72,56,72,64,72,64,64,64,64,64,64,72,56,72,64,72,64,56,20,72,24,16,4,16,20,16,12,8,12,60,28,32,40,52,61,24,12,65,52,76,28,8,28,12,40,61,44,64,12,16,24,12,12,8,8,12,12,8,12,12,8,12,12,8,8,12,12,8,12,12,8,8,16,8,8,8,12,12,12,12,8,16,8,12,12,12,12,8,12,12,12,12,8,16,24,32,32,32,40,17,80,16,8,8,4,8,8,20,8,4,8,24,16,16,12,16,16,8,8,16,8,16,8,12,24,16,20,13,12,24,8,4,8,8,8,16,24,8,17,20,16,4,8,8,16,16,20,13,12,24,8,4,8,4,4,16,24,16,8,4,8,8,8,8,16,8,8,8,24,8,12,16,24,16,8,17,20,16,4,8,8,16,16,20,5,20,24,8,4,8,16,24,16,9,20,16,16,12,8,8,16,24,16,12,16,16,16,8,8,24,8,12,24,24,12,13,12,24,8,4,8,16,24,16,9,20,16,16,4,8,8,16,24,12,13,20,16,8,4,8,4,4,4,20,24,16,12,16,16,16,16,16,8,8,20,16,24,16,9,20,24,4,8,16,24,20,5,20,24,8,4,8,16,16,24,8,17,20,16,12,4,4,8,4,20,16,24,12,8,8,8,16,8,8,16,16,8,12,24,24,12,13,12,24,8,4,8,16,24,20,13,20,24,4,8,8,32,24,21,32,12,4,4,8,32,24,4,8,8,8,16,16,16,24,8,28,32,17,20,32,4,8,8,24,24,17,28,16,4,8,8,40,25,28,16,12,8,8,40,16,12,8,16,24,16,24,28,40,25,36,12,8,24,36,25,32,4,8,40,25,36,16,12,8,4,36,24,12,16,24,16,32,28,40,37,32,12,40,33,44,12,24,41,44,12,8,8,16,48,4,8,16,32,24,16,20,48,33,36,12,32,33,44,12,8,16,44,33,28,8,8,8,48,20,24,24,40,8,44,49,36,12,16,48,45,20,24,41,52,12,8,24,40,12,16,32,40,8,44,41,44,12,8,52,49,20,48,37,32,12,8,8,32,36,8,32,24,32,16,60,37,24,12,32,49,40,8,48,45,28,8,4};
    unsigned prev = 0;
    for( int i=0; i<NUM_ELEM; i++ ){
        unsigned ind = index[i];
	unsigned val = value[i];
	while( prev < ind ){
	    input[prev] = 0;
	    prev += 1;
	}
	input[prev] = val;
	prev += 1;
    }
    unsigned size = 0;
    checkpoint_start();
    gem5_dump_stats();
    gem5_reset_stats();
    for( int j=0; j<NUM_ACCESS; j++ ){
        size = input[j%SIZE];
        if(size){
	    int array[size];
	    umemset(array,0,size);
	}
	count = 0;
	while(count < loop_counter){
            count += 1;
	}
    }
    checkpoint_end();
    gem5_dump_stats();
    gem5_reset_stats();
    checkpoint_stats();

    return 0;
}
