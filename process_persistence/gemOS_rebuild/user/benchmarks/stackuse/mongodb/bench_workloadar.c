#include<ulib.h>

#define NUM_ACCESS 1980
#define NUM_ELEM 580
#define MICRO_SEC 3000 //3000 cycles
#define SIZE 1980

#define RDTSC_START()            \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         : "=r" (start_hi), "=r" (start_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");

#define RDTSC_STOP()              \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         "CPUID\n\t" \
                         : "=r" (end_hi), "=r" (end_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");


u64 uelapsed(u32 start_hi, u32 start_lo, u32 end_hi, u32 end_lo)
{
        u64 start = (((u64)start_hi) << 32) | start_lo;
        u64 end   = (((u64)end_hi)   << 32) | end_lo;
        return end-start;
}
int main(u64 arg1, u64 arg2, u64 arg3, u64 arg4, u64 arg5)
{
    u32 start_hi = 0, start_lo = 0, end_hi = 0, end_lo = 0;
    u32 target_count = MICRO_SEC*100; //values at 100 usec interval
    u32 loop_counter = 1024;
    u64 rdtsc_count = 0;
    register int count = 0;
    do{
        count = 0;
	rdtsc_count = 0;
	loop_counter = (loop_counter<<1);
        RDTSC_START();    
        while(count < loop_counter){
            count += 1;
	} 
        RDTSC_STOP();
        rdtsc_count = uelapsed(start_hi,start_lo,end_hi,end_lo);
    }while(rdtsc_count<target_count);
    printf("counter:%u rdtsc:%u\n",loop_counter,rdtsc_count);
    u16* input = (u16*)mmap(NULL, SIZE*sizeof(u16), PROT_READ | PROT_WRITE, 0);
    u32 index[NUM_ELEM] = {0,3,4,8,9,11,12,13,14,22,26,33,34,35,36,44,57,60,65,84,85,86,88,89,90,92,93,94,95,96,97,98,100,101,102,103,104,105,107,108,109,110,111,112,113,114,115,116,117,119,120,121,122,123,124,125,127,128,130,131,132,134,136,137,138,139,140,141,142,147,148,149,150,154,156,157,158,159,160,161,169,172,174,175,176,178,181,187,188,189,190,191,203,204,219,226,227,230,236,247,248,253,258,260,262,263,268,272,273,274,275,278,284,285,291,292,296,301,308,309,316,323,345,353,354,364,369,370,372,373,384,385,390,393,397,400,404,410,425,427,431,439,442,443,444,445,447,448,449,452,453,454,455,456,458,459,461,466,467,468,469,476,477,481,482,484,485,486,487,488,490,499,500,503,504,505,506,510,511,524,526,528,529,541,544,549,558,559,567,568,569,570,571,572,573,575,576,580,581,582,583,588,592,594,602,605,614,615,616,617,618,619,620,621,622,623,624,625,626,627,628,629,630,634,650,657,658,660,662,668,669,670,671,672,674,681,684,689,691,705,707,713,715,723,724,727,747,753,754,755,756,771,777,778,781,783,786,790,797,801,810,815,816,823,824,826,830,831,833,834,835,837,847,848,850,861,862,863,864,865,866,871,872,879,884,892,899,902,908,909,912,913,914,927,988,1005,1006,1007,1008,1009,1010,1011,1012,1013,1014,1016,1018,1023,1024,1025,1026,1027,1028,1029,1030,1032,1034,1038,1039,1040,1041,1042,1044,1045,1046,1048,1051,1053,1054,1057,1059,1065,1066,1069,1075,1077,1084,1090,1101,1102,1112,1120,1121,1122,1126,1131,1138,1140,1141,1142,1150,1159,1166,1168,1174,1175,1176,1177,1178,1179,1180,1182,1184,1186,1188,1194,1204,1205,1206,1207,1210,1211,1212,1213,1223,1230,1235,1236,1239,1240,1241,1246,1251,1255,1259,1263,1271,1272,1276,1277,1278,1279,1281,1286,1287,1288,1289,1290,1294,1297,1301,1315,1320,1321,1331,1334,1335,1338,1339,1347,1348,1356,1371,1372,1379,1409,1412,1459,1460,1461,1462,1463,1465,1467,1468,1469,1470,1471,1472,1473,1474,1475,1476,1482,1483,1484,1485,1486,1488,1493,1503,1505,1506,1507,1508,1513,1518,1526,1527,1528,1535,1541,1542,1553,1577,1578,1579,1580,1588,1589,1594,1596,1604,1605,1606,1613,1614,1615,1620,1644,1659,1662,1663,1667,1668,1669,1693,1694,1699,1700,1701,1702,1706,1710,1713,1716,1721,1722,1723,1725,1730,1731,1733,1734,1737,1738,1739,1740,1744,1746,1747,1748,1755,1759,1760,1767,1768,1772,1777,1792,1793,1796,1797,1800,1801,1802,1819,1825,1826,1843,1849,1850,1851,1852,1853,1855,1857,1858,1859,1861,1864,1868,1874,1875,1876,1877,1878,1879,1880,1881,1882,1883,1886,1887,1888,1892,1894,1895,1896,1905,1912,1913,1914,1915,1916,1918,1919,1921,1922,1923,1924,1925,1926,1929,1932,1933,1934,1937,1938,1939,1944,1945,1949,1955,1966,1967,1969,1970,1973,1979};
    u32 value[NUM_ELEM] = {16,16,16,12,8,4,20,16,4,8,8,8,16,20,8,32,4,8,8,4,9,16,8,16,40,16,12,8,64,8,20,16,12,16,20,40,36,8,12,8,16,16,40,20,8,8,24,24,20,8,4,24,36,16,16,9,40,20,8,40,4,5,5,48,21,8,16,12,16,48,32,8,4,16,32,56,44,48,28,60,20,8,8,24,20,32,8,48,16,84,16,1,4,16,8,48,17,24,8,20,72,20,4,8,8,16,32,8,81,52,48,8,56,32,48,29,16,8,40,16,1,8,8,56,20,8,40,36,24,16,8,64,8,16,48,8,24,8,8,8,16,40,16,40,64,24,28,5,8,16,48,32,24,20,8,8,8,56,8,8,16,16,64,5,8,24,40,72,56,8,8,4,32,48,64,52,8,32,32,8,8,24,8,24,32,40,20,16,40,8,8,40,16,48,32,16,32,38,80,48,24,32,8,8,8,24,40,40,72,32,48,64,48,40,8,16,8,16,40,32,8,16,8,8,8,8,16,16,16,64,24,64,72,8,1,8,16,8,24,32,8,8,24,24,48,8,8,72,32,8,8,8,21,4,12,32,8,24,52,8,20,8,16,8,8,16,32,16,8,8,16,1,8,8,8,64,16,64,40,40,16,40,24,5,8,8,56,8,49,13,1,72,12,8,8,8,48,40,45,56,65,54,24,12,12,8,8,64,60,45,64,65,54,40,4,24,8,8,64,8,72,1,17,72,4,8,8,8,8,32,24,16,16,20,56,8,64,32,12,24,8,4,49,33,4,28,8,4,40,24,8,16,8,8,72,61,64,33,14,64,12,8,16,8,24,12,24,41,36,68,8,24,20,53,4,8,20,8,16,16,16,8,32,8,24,8,24,40,24,20,28,40,8,4,4,44,32,64,36,1,24,8,32,9,8,8,24,16,40,48,8,8,24,24,8,8,32,8,81,64,80,32,40,8,32,16,56,52,89,88,40,8,40,48,4,8,8,28,32,8,8,8,24,76,32,56,4,40,64,8,8,24,4,1,4,1,32,24,32,12,16,8,64,28,8,24,32,8,48,4,56,16,24,64,88,8,48,68,40,64,72,8,9,8,16,32,24,76,16,8,24,40,8,24,72,40,48,64,8,72,56,48,8,48,8,80,8,8,56,24,40,56,8,48,16,8,8,8,72,8,32,56,24,32,4,1,16,20,57,8,4,4,8,56,44,24,24,44,28,24,40,76,8,8,20,1,21,24,16,8,88,56,40,16,12,1,16,16,28,72,65,104,72,40,32,60,1,13,48,8,48,8,16,16,8,8,16,64,8,40};
    unsigned prev = 0;
    for( int i=0; i<NUM_ELEM; i++ ){
        unsigned ind = index[i];
	unsigned val = value[i];
	while( prev < ind ){
	    input[prev] = 0;
	    prev += 1;
	}
	input[prev] = val;
	prev += 1;
    }
    unsigned size = 0;
    checkpoint_start();
    gem5_dump_stats();
    gem5_reset_stats();
    for( int j=0; j<NUM_ACCESS; j++ ){
        size = input[j%SIZE];
        if(size){
	    int array[size];
	    umemset(array,0,size);
	}
	count = 0;
	while(count < loop_counter){
            count += 1;
	}
    }
    checkpoint_end();
    gem5_dump_stats();
    gem5_reset_stats();
    checkpoint_stats();
    return 0;
}
