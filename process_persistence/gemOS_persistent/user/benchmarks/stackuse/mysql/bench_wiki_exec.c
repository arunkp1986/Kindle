#include<ulib.h>

#define NUM_ACCESS 570
#define NUM_ELEM 638
#define MICRO_SEC 3000 //3000 cycles
#define SIZE 2838 //max of index value

#define RDTSC_START()            \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         : "=r" (start_hi), "=r" (start_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");

#define RDTSC_STOP()              \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         "CPUID\n\t" \
                         : "=r" (end_hi), "=r" (end_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");


u64 uelapsed(u32 start_hi, u32 start_lo, u32 end_hi, u32 end_lo)
{
        u64 start = (((u64)start_hi) << 32) | start_lo;
        u64 end   = (((u64)end_hi)   << 32) | end_lo;
        return end-start;
}
int main(u64 arg1, u64 arg2, u64 arg3, u64 arg4, u64 arg5)
{
    u32 start_hi = 0, start_lo = 0, end_hi = 0, end_lo = 0;
    u32 target_count = MICRO_SEC*100; //values at 100 usec interval
    u32 loop_counter = 1024;
    u64 rdtsc_count = 0;
    register int count = 0;
    do{
        count = 0;
	rdtsc_count = 0;
	loop_counter = (loop_counter<<1);
        RDTSC_START();    
        while(count < loop_counter){
            count += 1;
	} 
        RDTSC_STOP();
        rdtsc_count = uelapsed(start_hi,start_lo,end_hi,end_lo);
    }while(rdtsc_count<target_count);
    printf("counter:%u rdtsc:%u\n",loop_counter,rdtsc_count);
    u16* input = (u16*)mmap(NULL, SIZE*sizeof(u16), PROT_READ | PROT_WRITE, 0);
    u32 index[NUM_ELEM] = {0,1,2,3,4,5,6,7,8,9,10,11,12,13,22,29,30,32,33,34,35,36,37,38,46,47,48,49,50,51,52,53,55,56,57,58,59,60,61,62,63,64,74,75,76,77,79,80,81,82,84,85,87,88,89,90,91,92,93,94,95,96,97,98,99,101,109,144,174,189,190,191,196,199,203,221,258,259,260,266,267,270,274,278,290,299,300,303,305,306,318,319,322,327,332,333,342,357,370,384,393,401,402,403,410,411,412,413,424,425,426,427,435,440,441,442,445,446,447,457,458,467,468,476,477,484,485,491,521,532,553,565,607,608,621,622,623,671,676,686,687,689,703,704,707,708,709,710,711,712,713,714,715,716,717,718,719,720,721,728,729,730,731,732,742,743,746,764,765,766,781,793,794,795,809,810,811,812,1035,1036,1037,1038,1039,1041,1042,1043,1044,1046,1047,1051,1065,1066,1072,1073,1074,1092,1112,1129,1142,1143,1144,1146,1147,1163,1188,1209,1222,1229,1233,1247,1248,1249,1256,1257,1258,1264,1265,1274,1275,1276,1277,1281,1284,1295,1303,1304,1325,1326,1327,1330,1350,1351,1363,1364,1365,1367,1368,1369,1370,1371,1372,1373,1374,1375,1376,1377,1379,1390,1391,1400,1411,1412,1415,1416,1421,1422,1430,1431,1435,1436,1440,1451,1466,1467,1470,1483,1484,1485,1487,1519,1522,1535,1536,1537,1544,1553,1554,1555,1566,1569,1596,1619,1620,1621,1622,1638,1639,1651,1652,1653,1658,1659,1660,1661,1673,1674,1696,1703,1704,1719,1726,1734,1742,1743,1747,1765,1782,1783,1784,1791,1801,1802,1803,1804,1809,1820,1831,1834,1844,1856,1862,1868,1897,1910,1921,1922,1923,1926,1933,1940,1941,1946,1953,1954,1955,1956,1957,1958,1960,1961,1962,1963,1964,1965,1966,1967,1968,1977,1978,1979,1982,1987,1988,1989,1999,2000,2001,2022,2023,2024,2025,2026,2027,2028,2029,2031,2032,2033,2034,2035,2037,2038,2039,2040,2041,2042,2043,2050,2051,2058,2064,2065,2066,2067,2068,2070,2071,2072,2073,2074,2075,2076,2077,2078,2079,2080,2081,2082,2083,2084,2085,2086,2087,2088,2089,2093,2094,2095,2096,2097,2098,2099,2100,2101,2102,2103,2104,2105,2106,2107,2108,2109,2110,2111,2112,2113,2114,2115,2118,2126,2127,2128,2131,2132,2133,2134,2135,2136,2137,2140,2141,2142,2143,2144,2145,2146,2147,2148,2149,2150,2151,2152,2154,2159,2160,2176,2181,2185,2191,2198,2211,2222,2223,2230,2231,2239,2245,2261,2279,2280,2284,2293,2295,2306,2313,2338,2361,2362,2365,2370,2371,2376,2377,2384,2385,2393,2394,2395,2404,2408,2417,2418,2419,2445,2446,2455,2474,2489,2493,2498,2499,2500,2501,2502,2509,2510,2513,2518,2519,2528,2529,2534,2540,2544,2549,2550,2551,2557,2558,2561,2566,2567,2568,2574,2578,2583,2584,2585,2592,2596,2597,2603,2604,2605,2606,2611,2612,2613,2614,2629,2630,2631,2632,2633,2634,2635,2636,2639,2640,2641,2642,2643,2644,2646,2647,2648,2653,2654,2655,2656,2657,2658,2659,2660,2661,2664,2665,2666,2668,2669,2670,2671,2672,2677,2678,2679,2680,2681,2682,2683,2684,2685,2686,2687,2688,2689,2692,2694,2695,2696,2697,2699,2700,2701,2702,2703,2711,2712,2713,2714,2715,2716,2717,2718,2719,2720,2722,2723,2724,2725,2726,2727,2728,2729,2730,2732,2734,2741,2742,2748,2749,2750,2767,2771,2775,2793,2795,2796,2802,2803,2806,2810,2830,2831,2835,2836,2837};
  u32 value[NUM_ELEM] = {24,8,24,16,24,8,8,8,16,16,4,12,8,4,8,8,12,16,16,4,8,12,8,8,8,8,8,8,8,8,12,16,8,16,16,24,16,24,24,12,16,40,8,24,8,24,12,16,24,4,4,24,4,12,16,16,12,8,32,12,12,16,4,8,16,28,8,8,8,24,8,8,8,8,8,8,8,8,8,8,24,8,8,8,8,16,8,8,8,8,8,8,16,8,8,32,8,8,20,24,8,16,40,16,12,32,24,8,16,24,32,8,16,28,32,8,16,40,8,8,24,8,16,24,16,4,8,8,20,16,16,8,16,12,24,40,8,8,8,40,8,8,8,32,16,16,16,20,24,48,24,16,32,12,24,48,36,16,8,8,32,40,52,24,8,8,8,40,40,12,8,24,40,32,24,52,36,40,8,24,32,20,16,8,40,36,16,6,2,32,8,40,8,48,16,8,8,8,24,40,16,8,8,8,8,8,8,24,8,24,40,25,16,48,16,2,8,24,32,8,24,16,16,8,24,40,32,32,28,8,12,20,8,28,8,32,24,40,40,16,16,28,12,28,8,28,4,8,24,16,8,16,8,8,8,24,8,24,8,16,8,8,32,24,8,8,40,8,8,8,16,32,40,8,8,8,40,40,25,8,8,24,56,36,8,16,8,16,44,16,32,40,48,4,12,24,16,16,8,8,4,4,32,8,8,8,8,42,24,24,32,20,32,24,8,8,8,8,8,8,24,16,8,8,40,56,8,24,8,56,8,16,4,36,64,52,64,52,16,16,48,72,56,40,28,44,16,24,60,8,24,8,12,4,16,60,48,8,20,72,40,44,72,28,16,24,16,32,48,24,40,36,40,28,40,12,4,8,8,24,16,4,40,28,8,8,16,48,28,32,16,72,56,68,52,8,16,16,48,72,56,44,52,28,4,32,16,20,16,16,32,64,52,40,36,16,16,8,32,48,20,16,64,36,28,20,60,16,8,16,36,24,8,8,48,8,44,16,16,40,72,60,76,16,16,24,56,80,48,36,60,16,8,8,16,24,8,8,4,32,32,8,32,16,8,8,16,8,60,8,8,56,8,4,20,8,8,40,16,48,40,1,32,8,8,8,64,16,8,4,8,60,20,56,8,8,17,8,16,8,72,76,36,17,8,8,16,24,72,40,8,16,8,16,40,80,40,8,8,16,32,80,48,8,16,40,88,32,8,8,18,56,24,32,24,21,80,60,24,24,8,40,40,88,52,24,5,24,57,88,40,16,9,8,32,40,40,40,64,52,72,20,32,41,24,8,8,16,40,72,40,32,8,32,24,24,28,36,32,8,12,12,48,40,20,16,12,32,40,80,40,16,40,32,64,32,8,40,14,8,56,72,68,52,16,16,48,72,56,48,8,44,32,16,16,32,8,8,16,24,92,8,24,32,8,8,8,8,40,48,24,8,8,8,32,88,44};
    unsigned prev = 0;
    for( int i=0; i<NUM_ELEM; i++ ){
        unsigned ind = index[i];
	unsigned val = value[i];
	while(prev < ind){
	    input[prev] = 0;
	    prev += 1;
	}
	input[prev] = val;
	prev += 1;
    }
    unsigned size = 0;
    checkpoint_start();
    gem5_dump_stats();
    gem5_reset_stats();
    for( int j=0; j<NUM_ACCESS; j++ ){
        size = input[j%SIZE];
        if(size){
	    int array[size];
	    umemset(array,0,size);
	}
	count = 0;
	while(count < loop_counter){
            count += 1;
	}
    }
    checkpoint_end();
    gem5_dump_stats();
    gem5_reset_stats();
    checkpoint_stats();
    return 0;
}
