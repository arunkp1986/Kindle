#include<ulib.h>

#define NUM_ACCESS 6869
#define NUM_ELEM 589
#define MICRO_SEC 3000 //3000 cycles
#define SIZE 6870
#define RDTSC_START()            \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         : "=r" (start_hi), "=r" (start_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");

#define RDTSC_STOP()              \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         "CPUID\n\t" \
                         : "=r" (end_hi), "=r" (end_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");


u64 uelapsed(u32 start_hi, u32 start_lo, u32 end_hi, u32 end_lo)
{
        u64 start = (((u64)start_hi) << 32) | start_lo;
        u64 end   = (((u64)end_hi)   << 32) | end_lo;
        return end-start;
}
int main(u64 arg1, u64 arg2, u64 arg3, u64 arg4, u64 arg5)
{
    u32 start_hi = 0, start_lo = 0, end_hi = 0, end_lo = 0;
    u32 target_count = MICRO_SEC*100; //values at 100 usec interval
    u32 loop_counter = 1024;
    u64 rdtsc_count = 0;
    register int count = 0;
    do{
        count = 0;
	rdtsc_count = 0;
	loop_counter = (loop_counter<<1);
        RDTSC_START();    
        while(count < loop_counter){
            count += 1;
	} 
        RDTSC_STOP();
        rdtsc_count = uelapsed(start_hi,start_lo,end_hi,end_lo);
    }while(rdtsc_count<target_count);
    printf("counter:%u rdtsc:%u\n",loop_counter,rdtsc_count);
    u16* input = (u16*)mmap(NULL, SIZE*sizeof(u16), PROT_READ | PROT_WRITE, 0);
    u32 index[NUM_ELEM] ={0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,24,25,28,29,30,31,32,33,34,35,3750,3751,3752,3753,3754,3755,3756,3757,3758,3759,3760,3761,3762,3763,3764,3765,3766,3767,3768,3769,3770,4701,4702,4705,4706,4707,4708,4709,4710,4711,4712,4713,4714,4715,4716,4717,4719,4720,4721,4722,4723,4724,4725,4726,4728,4729,4730,4731,4732,4733,4734,4735,4736,4737,4739,4740,4741,4742,4743,4744,4745,4746,4747,4749,4750,4751,4752,4754,4755,4756,4757,4758,4759,4760,4761,4763,4764,4765,4766,4769,4770,4771,4772,4774,4775,4776,4777,4778,4779,4781,4783,4784,4785,4786,4788,4789,4790,4791,4792,4793,4795,4796,4797,4798,4800,4801,4802,4803,4805,4806,4807,4808,4809,4810,4812,4813,4814,4815,4817,4818,4819,4820,4821,4822,4824,4825,4826,4827,4828,4829,4831,4832,4833,4834,4836,4837,4838,4839,4840,4841,4842,4843,4844,4845,4846,4848,4849,4850,4851,4853,4854,4855,4856,4857,4858,4859,4860,4861,4862,4863,4864,4865,4866,4867,4868,4869,4870,4871,4872,4873,4874,4876,4877,4878,4879,4880,4881,4882,4883,4884,4885,4886,4887,4888,4889,4890,4891,4892,4893,4894,4895,4896,4897,4898,4899,4900,4901,4902,4903,4904,4905,4906,4907,4908,4909,4910,4911,4912,4913,4914,4915,4916,4917,4918,4919,4920,4921,4922,4923,4925,4926,4927,4929,4930,4931,4933,4934,4935,4937,4938,4939,4941,4942,4943,4945,4946,4947,4949,4950,4951,4952,4953,4954,4955,4957,4958,4959,4960,4961,4962,4963,4964,4965,4966,4967,4968,4969,4970,4971,4972,4973,4974,4975,4976,4977,4978,4979,4980,4981,4982,4983,4984,4985,4986,4987,4988,4989,4990,4991,4992,4993,4994,4995,4996,4997,4998,4999,5000,5001,5002,5003,5004,5005,5006,5008,5009,5010,5012,5013,5014,5016,5017,5018,5019,5020,5021,5023,5024,5025,5026,5027,5028,5029,5030,5031,5032,5033,5034,5035,5036,5037,5038,5039,5040,5041,5042,5043,5044,5045,5046,5047,5048,5049,5050,5051,5052,5053,5055,5056,5057,5058,5059,5060,5061,5062,5063,5064,5065,5066,5067,5068,5069,5070,5071,5072,5073,5074,5075,5076,5077,5078,5079,5080,5081,5082,5083,5084,5085,5086,5087,5088,5089,5090,5091,5092,5093,5094,5095,5096,5097,5098,5099,5100,5101,5102,5103,5104,5106,5108,5109,5110,5111,5112,5113,5114,5115,5116,5117,5118,5119,5120,5121,5122,5123,5124,5125,5126,5127,5128,5129,5130,5131,5132,5133,5134,5135,5136,5137,5138,5139,5140,5141,5142,5143,5144,5145,5146,5147,5148,5149,5150,5151,5152,5153,5154,5155,5156,5157,5158,5159,5160,5161,5162,5163,5164,5167,5168,5169,5170,5525,5527,5528,5529,5530,5531,5532,5533,5534,5535,5536,5537,5538,5539,5540,5541,5542,5543,5544,5545,5546,5547,5548,5549,5550,5551,5552,5553,5554,5555,5556,5557,5558,5559,5560,5561,5562,5563,5564,5565,5566,5567,5568,5569,5570,5571,5572,5573,5574,5575,5576,5577,5578,5579,5580,5581,5582,5583,5584,5585,5586,5587,5588,5589,5590,5591,5592,5593,5594,5595,5596,5597,5598,5599,5600,5601,6837,6839,6840,6841,6842,6843,6844,6845,6846,6847,6848,6849,6850,6851,6853,6854,6855,6856,6857,6858,6859,6860,6861,6862,6863,6864,6865,6866,6867,6868,6869};
    u32 value[NUM_ELEM] = {16,24,88,40,32,36,24,48,56,32,40,48,84,56,48,64,56,24,64,32,48,80,24,76,32,48,72,80,16,16,80,44,28,20,16,32,72,24,64,64,16,88,24,56,56,16,72,56,24,48,24,80,60,4,8,12,16,20,12,8,4,8,4,8,8,4,4,8,8,8,8,4,4,8,16,40,20,16,32,16,24,8,28,44,25,32,12,24,16,33,36,20,32,48,8,4,16,8,12,12,16,44,25,32,28,40,24,12,8,20,8,4,8,4,4,8,8,4,4,4,4,8,8,8,4,4,8,8,4,4,4,4,8,8,4,4,8,8,4,4,8,8,4,4,4,4,8,8,4,4,8,8,4,4,4,4,8,8,4,4,4,4,8,8,4,4,8,8,4,4,4,4,8,4,4,4,4,8,8,4,4,8,8,4,20,16,8,8,16,8,24,8,16,8,16,9,17,32,40,40,32,40,40,24,4,16,40,24,32,40,16,24,16,8,16,24,16,8,16,24,16,16,8,32,8,16,16,24,8,16,8,32,8,16,8,32,8,16,8,32,8,16,8,32,8,16,16,24,8,24,8,32,24,8,32,24,8,32,24,8,32,24,8,32,24,8,32,24,8,32,24,8,32,8,16,8,32,24,16,24,8,16,16,24,8,16,16,24,8,16,24,16,8,16,24,16,8,16,24,16,8,16,24,16,8,16,24,16,8,16,24,16,8,16,32,8,16,8,32,8,16,16,24,8,16,16,32,24,8,32,24,8,32,24,8,32,8,16,40,24,16,24,16,16,32,8,24,32,8,16,32,8,24,24,16,24,24,16,24,16,24,16,16,32,16,16,32,8,16,40,24,32,8,24,24,16,24,8,32,16,16,32,8,16,40,16,24,24,24,40,8,24,32,24,24,16,24,40,8,24,32,24,24,16,24,40,16,24,24,24,32,16,24,32,16,24,24,24,32,16,40,29,48,48,32,48,64,48,48,48,32,64,56,56,56,48,72,48,56,56,56,56,64,48,56,64,48,56,48,40,48,56,64,32,64,56,56,56,48,72,48,48,56,56,56,56,64,48,56,56,56,56,64,48,64,56,48,48,12,48,52,4,20,36,20,8,16,56,20,48,40,52,85,52,48,12,8,28,12,77,68,60,16,16,20,4,65,72,72,12,28,12,8,12,12,12,12,12,12,12,12,12,12,12,12,12,12,16,8,12,12,12,12,16,8,16,8,12,12,12,12,12,12,12,12,12,12,12,12,16,8,40,32,32,32,25,64,48,20,36,60,28,40,48,44,85,20,60,57,12,73,56,40,44,40,48,44,69,36,16,77,36,48,69,12,8,64,28,8};
    unsigned prev = 0;
    for( int i=0; i<NUM_ELEM; i++ ){
        unsigned ind = index[i];
	unsigned val = value[i];
	while( prev < ind ){
	    input[prev] = 0;
	    prev += 1;
	}
	input[prev] = val;
	prev += 1;
    }
    unsigned size = 0;
    checkpoint_start();
    gem5_dump_stats();
    gem5_reset_stats();
    for( int j=0; j<NUM_ACCESS; j++ ){
        size = input[j%SIZE];
        if(size){
	    int array[size];
	    umemset(array,0,size);
	}
	count = 0;
	while(count < loop_counter){
            count += 1;
	}
    }
    checkpoint_end();
    gem5_dump_stats();
    gem5_reset_stats();
    checkpoint_stats();

    return 0;
}
