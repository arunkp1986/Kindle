#include<ulib.h>

#define NUM_ACCESS 570
#define NUM_ELEM 348
#define MICRO_SEC 3000 //3000 cycles
#define SIZE 2601 //max value in index


#define RDTSC_START()            \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         : "=r" (start_hi), "=r" (start_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");

#define RDTSC_STOP()              \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         "CPUID\n\t" \
                         : "=r" (end_hi), "=r" (end_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");


u64 uelapsed(u32 start_hi, u32 start_lo, u32 end_hi, u32 end_lo)
{
        u64 start = (((u64)start_hi) << 32) | start_lo;
        u64 end   = (((u64)end_hi)   << 32) | end_lo;
        return end-start;
}
int main(u64 arg1, u64 arg2, u64 arg3, u64 arg4, u64 arg5)
{
    u32 start_hi = 0, start_lo = 0, end_hi = 0, end_lo = 0;
    u32 target_count = MICRO_SEC*100; //values at 100 usec interval
    u32 loop_counter = 1024;
    u64 rdtsc_count = 0;
    register int count = 0;
    do{
        count = 0;
	rdtsc_count = 0;
	loop_counter = (loop_counter<<1);
        RDTSC_START();    
        while(count < loop_counter){
            count += 1;
	} 
        RDTSC_STOP();
        rdtsc_count = uelapsed(start_hi,start_lo,end_hi,end_lo);
    }while(rdtsc_count<target_count);
    printf("counter:%u rdtsc:%u\n",loop_counter,rdtsc_count);
    u16* input = (u16*)mmap(NULL, SIZE*sizeof(u16), PROT_READ | PROT_WRITE, 0);
    u32 index[NUM_ELEM] = {0,1,3,5,6,7,8,9,10,11,12,13,14,15,16,97,98,99,101,102,103,104,105,106,107,108,109,110,112,113,114,115,116,117,336,337,338,340,341,342,343,344,345,346,347,349,350,351,352,353,354,355,356,357,358,359,360,361,718,719,720,721,723,724,725,726,727,728,729,730,731,732,733,734,735,736,737,738,764,779,780,893,909,910,911,912,913,914,916,917,918,919,920,921,922,923,924,925,926,927,928,929,930,931,1010,1011,1012,1014,1015,1016,1017,1018,1019,1020,1021,1022,1023,1024,1025,1026,1027,1028,1029,1030,1031,1032,1033,1034,1035,1036,1037,1038,1040,1041,1042,1043,1044,1046,1047,1048,1049,1050,1051,1052,1053,1054,1069,1070,1110,1111,1112,1113,1115,1116,1117,1118,1119,1120,1121,1122,1123,1124,1125,1126,1127,1128,1129,1130,1355,1356,1357,1359,1360,1361,1362,1363,1364,1365,1366,1367,1368,1369,1370,1371,1372,1373,1374,1375,1376,1377,1378,1379,1731,1732,1733,1734,1736,1737,1738,1739,1740,1741,1742,1743,1744,1745,1746,1747,1748,1749,1750,1751,1925,1926,1927,1929,1930,1931,1932,1933,1934,1935,1936,1937,1938,1939,1940,1941,1942,1943,1944,2044,2045,2046,2048,2049,2050,2051,2052,2053,2054,2055,2056,2057,2058,2060,2061,2062,2063,2064,2065,2066,2067,2068,2069,2070,2071,2072,2073,2075,2076,2077,2078,2079,2081,2082,2083,2084,2085,2086,2124,2125,2126,2128,2129,2130,2131,2132,2133,2134,2135,2136,2137,2138,2139,2140,2141,2142,2143,2372,2373,2374,2375,2377,2378,2379,2380,2381,2382,2383,2384,2385,2386,2387,2388,2389,2390,2391,2392,2393,2394,2395,2396,2397,2398,2423,2438,2439,2570,2571,2572,2574,2575,2576,2577,2578,2580,2581,2582,2583,2584,2585,2586,2587,2588,2589,2590,2591,2592,2593,2594,2595,2596,2597,2598,2599,2600};
   u32 value[NUM_ELEM] = {72,48,56,16,88,60,84,16,8,40,96,60,40,68,16,16,28,52,8,8,56,44,24,64,64,76,60,8,40,88,68,40,68,16,36,40,20,8,56,32,80,44,16,92,36,28,60,56,60,76,16,8,40,88,76,32,68,16,16,20,44,16,8,60,40,24,80,64,68,44,8,8,48,88,68,40,60,16,16,56,40,16,56,48,12,40,16,20,8,56,36,32,48,80,68,68,8,8,64,88,56,52,52,8,36,40,20,8,56,40,72,92,66,28,84,56,48,8,8,48,68,69,50,33,24,24,80,32,88,8,48,8,64,72,76,52,8,40,72,64,48,36,44,16,8,8,64,32,16,20,40,20,8,56,28,40,28,88,60,92,16,8,32,88,72,44,68,16,36,40,20,8,56,40,80,36,24,84,16,24,44,80,68,68,16,8,64,88,48,56,48,8,8,28,44,16,12,56,40,24,60,80,76,60,8,8,72,72,52,40,68,8,36,40,20,8,56,44,24,48,80,76,60,8,8,64,88,56,52,52,8,16,36,44,8,24,40,64,88,80,34,56,68,72,24,40,48,81,24,50,33,48,24,64,48,64,8,24,32,40,80,76,60,16,64,88,56,56,48,8,28,48,20,8,48,20,56,24,88,52,92,16,8,40,88,68,40,68,16,16,20,40,20,8,56,32,80,44,8,92,24,8,44,72,60,92,16,8,32,80,80,44,44,32,8,16,40,56,16,28,52,8,40,32,80,52,25,96,80,48,56,64,52,24,8,40,48,8,48,8,48,58,8,81,92,69,48};
    unsigned prev = 0;
    for( int i=0; i<NUM_ELEM; i++ ){
        unsigned ind = index[i];
	unsigned val = value[i];
	while( prev < ind ){
	    input[prev] = 0;
	    prev += 1;
	}
	input[prev] = val;
	prev += 1;
    }
    unsigned size = 0;
    checkpoint_start();
    gem5_dump_stats();
    gem5_reset_stats();
    for( int j=0; j<NUM_ACCESS; j++ ){
        size = input[j%SIZE];
        if(size){
	    int array[size];
	    umemset(array,0,size);
	}
	count = 0;
	while(count < loop_counter){
            count += 1;
	}
    }
    checkpoint_end();
    gem5_dump_stats();
    gem5_reset_stats();
    checkpoint_stats();
    return 0;
}
