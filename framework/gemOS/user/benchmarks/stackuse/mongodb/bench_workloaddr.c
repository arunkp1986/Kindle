#include<ulib.h>

#define NUM_ACCESS 1578
#define NUM_ELEM 503
#define MICRO_SEC 3000 //3000 cycles
#define SIZE 1578
#define RDTSC_START()            \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         : "=r" (start_hi), "=r" (start_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");

#define RDTSC_STOP()              \
        __asm__ volatile("RDTSCP\n\t" \
                         "mov %%edx, %0\n\t" \
                         "mov %%eax, %1\n\t" \
                         "CPUID\n\t" \
                         : "=r" (end_hi), "=r" (end_lo) \
                         :: "%rax", "%rbx", "%rcx", "%rdx");


u64 uelapsed(u32 start_hi, u32 start_lo, u32 end_hi, u32 end_lo)
{
        u64 start = (((u64)start_hi) << 32) | start_lo;
        u64 end   = (((u64)end_hi)   << 32) | end_lo;
        return end-start;
}
int main(u64 arg1, u64 arg2, u64 arg3, u64 arg4, u64 arg5)
{
    u32 start_hi = 0, start_lo = 0, end_hi = 0, end_lo = 0;
    u32 target_count = MICRO_SEC*100; //values at 100 usec interval
    u32 loop_counter = 1024;
    u64 rdtsc_count = 0;
    register int count = 0;
    do{
        count = 0;
	rdtsc_count = 0;
	loop_counter = (loop_counter<<1);
        RDTSC_START();    
        while(count < loop_counter){
            count += 1;
	} 
        RDTSC_STOP();
        rdtsc_count = uelapsed(start_hi,start_lo,end_hi,end_lo);
    }while(rdtsc_count<target_count);
    printf("counter:%u rdtsc:%u\n",loop_counter,rdtsc_count);
    u16* input = (u16*)mmap(NULL, SIZE*sizeof(u16), PROT_READ | PROT_WRITE, 0);
    u32 index[NUM_ELEM] ={0,1,5,6,7,8,9,10,14,18,19,20,21,22,23,25,26,27,30,31,32,33,41,43,45,48,53,54,60,61,62,63,66,67,68,70,71,72,73,74,75,76,78,94,95,97,99,103,107,111,113,128,139,140,141,144,146,165,166,169,174,175,178,184,185,188,191,195,205,206,211,217,220,221,222,223,224,230,237,238,247,248,249,258,259,264,265,267,268,270,273,277,282,286,293,294,305,310,311,315,316,317,323,328,329,330,334,341,347,350,355,356,362,366,375,381,384,389,390,394,401,402,419,432,433,434,435,437,444,445,448,449,450,451,452,453,454,455,456,471,472,481,484,485,490,504,506,508,509,518,522,536,539,541,542,543,544,548,551,553,554,556,562,570,574,575,576,577,578,579,580,581,582,583,584,587,588,589,590,591,592,593,594,595,597,598,599,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,619,620,621,624,625,626,627,628,629,630,631,632,633,634,635,636,637,640,642,651,652,653,654,655,656,659,672,676,677,681,682,685,688,689,695,696,699,709,724,725,726,731,737,759,760,764,770,775,782,785,793,794,806,811,821,824,828,836,844,858,859,866,892,893,894,895,896,902,905,918,923,933,935,953,957,958,963,986,989,993,994,996,999,1006,1007,1010,1019,1021,1022,1023,1024,1025,1026,1027,1029,1030,1031,1032,1033,1035,1036,1037,1038,1039,1040,1042,1043,1044,1045,1046,1048,1049,1050,1085,1086,1089,1093,1098,1099,1100,1101,1102,1103,1107,1108,1109,1110,1116,1118,1120,1121,1125,1126,1129,1130,1133,1134,1136,1137,1138,1139,1140,1145,1149,1154,1155,1160,1161,1169,1175,1186,1210,1212,1221,1227,1228,1230,1231,1232,1244,1248,1249,1252,1257,1258,1261,1262,1288,1292,1293,1296,1304,1308,1316,1321,1325,1362,1363,1364,1365,1366,1367,1368,1369,1370,1375,1377,1383,1384,1386,1388,1389,1390,1391,1392,1393,1394,1395,1396,1397,1398,1399,1401,1402,1403,1404,1405,1406,1407,1408,1410,1411,1412,1413,1415,1416,1417,1418,1419,1420,1421,1423,1424,1425,1426,1427,1428,1429,1430,1431,1432,1433,1434,1435,1436,1437,1438,1439,1440,1441,1443,1444,1445,1446,1447,1449,1450,1451,1452,1453,1454,1456,1457,1462,1463,1466,1467,1468,1469,1470,1471,1483,1489,1506,1513,1514,1515,1516,1518,1519,1521,1531,1535,1536,1537,1538,1539,1540,1548,1549,1550,1551,1552,1554,1555,1556,1559,1560,1561,1562,1565,1566,1567,1568,1572,1573,1574,1575,1576,1577};
    u32 value[NUM_ELEM] = {16,32,4,28,8,16,12,4,8,16,24,28,8,16,16,8,16,16,8,32,64,8,32,4,8,8,8,52,24,16,36,20,20,16,20,17,20,33,36,16,40,20,13,4,9,8,8,24,40,12,8,16,48,52,8,8,8,4,8,24,8,24,8,24,32,1,24,8,84,8,12,8,8,57,60,56,28,16,16,8,56,36,8,4,28,8,28,24,8,8,4,4,8,8,16,49,8,16,72,8,8,8,64,56,8,8,32,8,8,8,24,40,5,8,8,56,8,48,14,9,32,44,8,20,16,40,20,16,48,29,20,16,24,64,40,28,52,24,16,8,8,8,8,24,40,32,8,16,8,72,8,8,1,16,28,60,8,8,16,40,76,8,16,13,32,72,64,40,72,24,64,9,4,5,8,32,64,56,32,72,33,30,56,12,8,8,8,5,48,40,56,64,24,8,8,40,24,56,40,61,96,71,36,16,48,16,40,64,72,56,73,40,45,48,40,33,8,36,50,36,16,32,8,80,24,64,64,8,1,16,8,16,32,8,8,16,8,44,8,8,24,24,76,16,32,32,32,8,8,8,8,8,8,32,32,8,41,8,32,56,56,8,8,40,8,40,88,97,88,32,8,32,24,8,8,24,8,40,8,32,8,24,16,48,8,24,40,32,8,8,8,24,88,65,80,56,72,32,16,48,48,8,24,80,73,88,48,32,16,16,16,64,8,24,16,8,1,8,8,16,48,88,24,56,64,8,40,56,72,16,24,8,8,24,40,32,8,64,24,32,16,16,48,40,40,8,8,24,16,24,32,8,28,1,5,56,44,40,68,1,5,56,8,8,48,8,16,41,1,4,9,32,8,16,8,24,8,48,8,24,73,68,60,8,80,64,56,28,12,1,64,28,1,37,24,40,56,42,4,57,32,48,80,20,1,53,8,56,81,5,65,32,64,56,49,68,52,32,28,40,20,16,80,13,32,72,68,60,16,24,81,24,12,80,28,8,16,72,44,32,60,20,12,8,65,44,72,36,56,52,48,68,16,8,80,12,24,24,16,36,24,20,4,9,8,25,8,48,36,24,44,17,16,8,20,16,72,48,56,40,8,8,28,40,20,24,32,8,13,48,56,64,8,72,56,48,8,88,80,96,40,73,76};
    unsigned prev = 0;
    for( int i=0; i<NUM_ELEM; i++ ){
        unsigned ind = index[i];
	unsigned val = value[i];
	while( prev < ind ){
	    input[prev] = 0;
	    prev += 1;
	}
	input[prev] = val;
	prev += 1;
    }
    unsigned size = 0;
    checkpoint_start();
    gem5_dump_stats();
    gem5_reset_stats();
    for( int j=0; j<NUM_ACCESS; j++ ){
        size = input[j%SIZE];
        if(size){
	    int array[size];
	    umemset(array,0,size);
	}
	count = 0;
	while(count < loop_counter){
            count += 1;
	}
    }
    checkpoint_end();
    gem5_dump_stats();
    gem5_reset_stats();
    checkpoint_stats();
    return 0;
}
